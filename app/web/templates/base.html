<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <!-- Sidebar configuration lives in one place so every page uses one shared nav structure. -->
  {% set sidebar_groups = [
    {
      "id": "dashboard",
      "label": "General",
      "default_open": true,
      "items": [
        {"label": "Dashboard", "href": "/"}
      ]
    },
    {
      "id": "ingredients",
      "label": "Ingredients",
      "default_open": true,
      "items": [
        {"label": "Ingredient SKUs", "href": "/ingredients"},
        {"label": "Ingredient Batches", "href": "/batches"}
      ]
    },
    {
      "id": "formulation",
      "label": "Formulation",
      "default_open": true,
      "items": [
        {"label": "Formulation Sets", "href": "/sets"},
        {"label": "Dry Weights", "href": "/dry_weights"},
        {"label": "Batch Selection", "href": "/batch_selection"}
      ]
    },
    {
      "id": "mixing",
      "label": "Mixing",
      "default_open": true,
      "items": [
        {"label": "Machine", "href": "/location_codes"},
        {"label": "How", "href": "/compounding_how"},
        {"label": "Pellet Bags", "href": "/pellet_bags"}
      ]
    },
    {
      "id": "conversion-1",
      "label": "Conversion 1 Film roll / coated board",
      "default_open": false,
      "items": [
        {"label": "Conversion 1 Context", "href": "/conversion1/context"},
        {"label": "Conversion 1 → How", "href": "/conversion1/how"},
        {"label": "Products", "href": "/conversion1/products"}
      ]
    },
    {
      "id": "system",
      "label": "System",
      "default_open": true,
      "items": [
        {"label": "Utilities", "href": "/utilities"}
      ]
    }
  ] %}

  <!-- Page shell keeps navigation on the left and main content on the right. -->
  <div class="app-shell">
    <!-- Sidebar uses the same visual language as content cards and inputs. -->
    <aside class="sidebar-nav" aria-label="Primary">
      <!-- Sidebar header keeps product identity visible above grouped links. -->
      <div class="sidebar-brand">
        <!-- Brand title text is split across two lines to prevent sidebar overflow and match the reference UI. -->
        <h1 class="site-title"><a href="/"><img class="site-logo" src="https://imagedelivery.net/WWB_1xpr0hQZ8HyAj4j9Mg/92e7e1f1-0166-44df-cfa5-5e92ca2dad00/thumb" alt="Notpla logo" /> <span class="site-title-text">Formulation<br />Tracker</span></a></h1>
        <span class="app-version">{{ request.app.state.settings.app_version }}</span>
      </div>

      <!-- Sidebar groups are rendered from config so behaviour and styling stay consistent. -->
      <nav class="sidebar-groups" aria-label="Main sections">
        {% for group in sidebar_groups %}
        <!-- Each group has a stable id used for localStorage persistence. -->
        <details class="nav-group" data-nav-group data-group-id="{{ group.id }}" {% if group.default_open %}open{% endif %}>
          <!-- Group summary row is the clickable accordion trigger. -->
          <summary>
            <span>{{ group.label }}</span>
            <span class="nav-group-chevron" aria-hidden="true">⌄</span>
          </summary>
          <!-- Group content wraps link rows for smooth open/close animation. -->
          <div class="nav-group-content">
            <div class="nav-group-items">
              {% for item in group["items"] %}
                {% if item.href %}
                <!-- Clickable destination rows include a marker class for active-route logic. -->
                <a href="{{ item.href }}" data-nav-item>{{ item.label }}</a>
                {% else %}
                <!-- Placeholder rows keep planned pages visible without enabling dead routes. -->
                <span class="nav-placeholder">{{ item.label }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </details>
        {% endfor %}
      </nav>

      <!-- Footer profile card anchors the sidebar similarly to the design reference. -->
      <div class="sidebar-user-card" aria-label="Signed in user">
        <div>
          <strong>{{ request.state.user_email if request.state.user_email else "Unknown user" }}</strong>
          <small>Signed in user</small>
        </div>
      </div>
    </aside>

    <!-- Content region keeps route templates unchanged while old top nav is removed. -->
    <div class="content-shell">
      <!-- Fixed-width inner shell preserves 1800px max width for content only. -->
      <div class="content-inner">
        <!-- Minimal sticky top bar only repeats the current page title for context. -->
        <!-- Title row stays in a dedicated rounded card to separate page context from panel content. -->
        <header class="content-header">
          <h2 class="content-title">{{ title }}</h2>
        </header>
        <!-- Main content block for page-specific template sections. -->
        <main>
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
  </div>
  <script src="/static/app.js"></script>
</body>
</html>
