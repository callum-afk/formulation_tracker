{% extends "base.html" %}
{% block content %}
<!-- Conversion 1 page mirrors Mixing Machine layout while generating conversion codes from pellet IDs. -->
<section class="panel">
  <!-- Create form heading aligns with requested Conversion 1 naming. -->
  <h2>Create conversion code</h2>
  <!-- Display server-side validation feedback for invalid or missing codes. -->
  {% if errors %}
  <div class="form-errors">
    {% for error in errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}
  <!-- Conversion form supports dropdown selection or manual entry for persisted code values. -->
  <form method="post" class="form-stack">
    <div class="grid">
      <!-- Pellet code dropdown lets users choose an existing pellet ID directly. -->
      <label>Pellet Code (dropdown)
        <select name="pellet_code_select">
          <option value="">Select formulation</option>
          {% for pellet_code in pellet_codes %}
          <option value="{{ pellet_code }}" {% if form_data and form_data.pellet_code_select == pellet_code %}selected{% endif %}>{{ pellet_code }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Manual pellet code field allows paste-entry while still validating existence server-side. -->
      <label>Pellet Code code (manual)
        <input name="pellet_code_manual" placeholder="AB AB AC" value="{{ form_data.pellet_code_manual if form_data else '' }}" list="conversion1-pellet-code-options" />
      </label>
      <!-- One combined conversion partner box shows BF-format label: partner name followed by machine. -->
      <label>Conversion partner
        <select name="conversion_partner_key" required>
          <option value="">Select partner</option>
          {% for option in partner_machine_options %}
          <option value="{{ option.key }}" {% if form_data and form_data.conversion_partner_key == option.key %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Optional manual partner-machine entry supports paste workflow with strict existence validation. -->
      <label>Conversion partner (manual)
        <input name="conversion_partner_manual" placeholder="Partner - Machine" value="{{ form_data.conversion_partner_manual if form_data else '' }}" list="conversion1-partner-machine-options" />
      </label>
      <!-- Calendar date input captures production date and backend converts it to YYMMDD code token. -->
      <label>Date of production
        <input type="date" name="production_date" required value="{{ form_data.production_date if form_data else '' }}" />
      </label>
      <!-- Static placeholder matches mockup visual while date token is derived from chosen calendar date. -->
      <label>YYMMDD code
        <input readonly value="{{ form_data.production_date[2:4] ~ form_data.production_date[5:7] ~ form_data.production_date[8:10] if form_data and form_data.production_date else '' }}" placeholder="240827" />
      </label>
    </div>
    <!-- Submit button generates the next conversion code after validating provided values exist. -->
    <button type="submit">Generate Conversion ID</button>
  </form>
  <!-- Hidden datalist supplies autocomplete choices for manual pellet code entry. -->
  <datalist id="conversion1-pellet-code-options">
    {% for pellet_code in pellet_codes %}
    <option value="{{ pellet_code }}"></option>
    {% endfor %}
  </datalist>
  <!-- Hidden datalist supplies autocomplete choices for manual partner-machine entry. -->
  <datalist id="conversion1-partner-machine-options">
    {% for label in partner_machine_labels %}
    <option value="{{ label }}"></option>
    {% endfor %}
  </datalist>
  <!-- Success output provides one-click copy for the generated conversion code. -->
  {% if result %}
  <p id="location-code-output"><strong>Generated conversion code:</strong> {{ result.how_code }}</p>
  {% endif %}
</section>

<!-- Conversion code table mirrors Machine page list section with filter and pagination controls. -->
<section class="panel">
  <h2>Conversion codes</h2>
  <!-- Filter form narrows table rows by matching generated conversion code text. -->
  <form method="get" class="inline-actions">
    <label>Filter conversion code <input name="q" value="{{ filters.q }}" placeholder="e.g. AB AC, 250112" /></label>
    <button type="submit">Filter</button>
  </form>
  <table>
    <thead>
      <tr>
        <th>Conversion code</th>
        <th>Owner</th>
        <th>Conversion partner</th>
        <th>Date created</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.conversion_code }}</td>
        <td>{{ row.owner }}</td>
        <td>{{ row.conversion_partner }}</td>
        <td>{{ row.created_at }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">No conversion codes loaded.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Pagination links preserve active filter query while moving through server-side pages. -->
  <div class="inline-actions">
    {% if pagination.has_prev %}
    <a href="/conversion1/how?page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}&q={{ filters.q | urlencode }}">Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }} of {{ ((pagination.total + pagination.page_size - 1) // pagination.page_size) if pagination.total else 1 }}</span>
    {% if pagination.has_next %}
    <a href="/conversion1/how?page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}&q={{ filters.q | urlencode }}">Next</a>
    {% endif %}
  </div>
</section>
{% endblock %}
