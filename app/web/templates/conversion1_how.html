{% extends "base.html" %}
{% block content %}
<!-- Conversion 1 How page hosts only How form controls and How entries table as required. -->
<section class="panel">
  <!-- Section heading matches required label exactly. -->
  <h2>How</h2>
  <!-- Validation errors are displayed above the form when backend checks fail. -->
  {% if errors %}
  <div class="form-errors">
    {% for error in errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}
  <!-- How form captures context linkage, processing metadata, and optional Google sheet URLs. -->
  <form method="post" class="form-stack">
    <!-- Top grid row follows three-column style for context and processing controls. -->
    <div class="grid">
      <!-- Context code dropdown references existing conversion context/location codes. -->
      <label>Context code
        <select name="context_code" required>
          <option value="">Select location code</option>
          {% for code in context_codes %}
          <option value="{{ code }}" {% if form_data and form_data.context_code == code %}selected{% endif %}>{{ code }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Processing code text input starts with AB by default and remains editable. -->
      <label>Processing code
        <input id="conversion1-processing-code" name="processing_code" value="{{ form_data.processing_code if form_data and form_data.processing_code else 'AB' }}" />
      </label>
      <!-- Centered small action button generates the next alphabetic two-letter processing code. -->
      <div style="display:flex;align-items:end;justify-content:center;">
        <button type="button" id="conversion1-generate-code">Generate code</button>
      </div>
      <!-- Failure mode dropdown keeps values constrained to configured failure mode list. -->
      <label>Failure mode
        <select name="failure_mode">
          <option value="">Select failure mode</option>
          {% for mode in failure_modes %}
          <option value="{{ mode }}" {% if form_data and form_data.failure_mode == mode %}selected{% endif %}>{{ mode }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Machine setup Google sheet URL input stores optional setup documentation link. -->
      <label>Google sheet link: Machine Setup File
        <input name="machine_setup_file" placeholder="https://..." value="{{ form_data.machine_setup_file if form_data else '' }}" />
      </label>
      <!-- Processed data Google sheet URL input stores optional output data link. -->
      <label>Google sheet link: Processed Data File
        <input name="processed_data_file" placeholder="https://..." value="{{ form_data.processed_data_file if form_data else '' }}" />
      </label>
    </div>
    <!-- Full-width primary submit action saves the Conversion How entry. -->
    <button type="submit">Save Conversion how</button>
  </form>
  <!-- Success output confirms generated Conversion 1 How code after save. -->
  {% if result %}
  <p><strong>Saved Conversion 1 How code:</strong> {{ result.how_code }}</p>
  {% endif %}
</section>

<!-- How entries panel renders paginated rows with required table headers and URL open links. -->
<section class="panel">
  <!-- Section heading matches required title exactly. -->
  <h2>How entries</h2>
  <!-- Entries table includes required and existing metadata columns. -->
  <table>
    <thead>
      <tr>
        <th>CONVERSION 1 HOW CODE</th>
        <th>DATE CREATED</th>
        <th>OWNER</th>
        <th>FAILURE MODE</th>
        <th>MACHINE SETUP FILE</th>
        <th>PROCESSED DATA FILE</th>
        <th>CONTEXT CODE</th>
        <th>PROCESS CODE</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.how_code }}</td>
        <td>{{ row.created_at }}</td>
        <td>{{ row.created_by }}</td>
        <td>{{ row.failure_mode or 'N/A' }}</td>
        <td>
          <div>{{ row.setup_link or '' }}</div>
          {% if row.setup_link %}<a href="{{ row.setup_link }}" target="_blank" rel="noopener noreferrer">Open</a>{% endif %}
        </td>
        <td>
          <div>{{ row.processed_data_link or '' }}</div>
          {% if row.processed_data_link %}<a href="{{ row.processed_data_link }}" target="_blank" rel="noopener noreferrer">Open</a>{% endif %}
        </td>
        <td>{{ row.context_code }}</td>
        <td>{{ row.process_code }}</td>
      </tr>
      {% else %}
      <tr><td colspan="8">No how entries loaded.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Pagination row follows existing table style and wording. -->
  <div class="inline-actions">
    {% if pagination.has_prev %}
    <a href="/conversion1/how?page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}">Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }} of {{ ((pagination.total + pagination.page_size - 1) // pagination.page_size) if pagination.total else 1 }}</span>
    {% if pagination.has_next %}
    <a href="/conversion1/how?page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}">Next</a>
    {% endif %}
  </div>
</section>

<!-- Inline script powers the centered Generate code button for client-side processing code increments. -->
<script>
  // Lookup processing-code input and generate button once DOM has rendered this template block.
  const processingInput = document.getElementById("conversion1-processing-code");
  const generateButton = document.getElementById("conversion1-generate-code");
  // Helper converts alphabetic code string (AA..ZZ) to numeric index for easy incrementing.
  const codeToNumber = (code) => {
    const normalized = (code || "AA").toUpperCase().replace(/[^A-Z]/g, "").padStart(2, "A").slice(-2);
    return ((normalized.charCodeAt(0) - 65) * 26) + (normalized.charCodeAt(1) - 65);
  };
  // Helper converts numeric index back into two-letter uppercase code token.
  const numberToCode = (value) => {
    const bounded = ((value % 676) + 676) % 676;
    const first = String.fromCharCode(65 + Math.floor(bounded / 26));
    const second = String.fromCharCode(65 + (bounded % 26));
    return `${first}${second}`;
  };
  // Button click increments current code by one step and writes updated value into input.
  generateButton?.addEventListener("click", () => {
    const nextValue = codeToNumber(processingInput?.value || "AB") + 1;
    if (processingInput) processingInput.value = numberToCode(nextValue);
  });
</script>
{% endblock %}
