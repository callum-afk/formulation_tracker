{% extends "base.html" %}
{% block content %}
<!-- Conversion 1 Context page hosts only conversion code generation UI and conversion code list table. -->
<section class="panel">
  <!-- Section heading matches required label exactly. -->
  <h2>Create conversion code</h2>
  <!-- Validation errors from backend are surfaced inline above form controls. -->
  {% if errors %}
  <div class="form-errors">
    {% for error in errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}
  <!-- Form creates a Conversion ID from pellet code, partner mapping, and production date. -->
  <form method="post" class="form-stack">
    <!-- Grid row contains primary code input fields in three responsive columns. -->
    <div class="grid">
      <!-- Dropdown lets users select an existing pellet code from persisted options. -->
      <label>Pellet Code (dropdown)
        <select name="pellet_code_select">
          <option value="">Select formulation</option>
          {% for pellet_code in pellet_codes %}
          <option value="{{ pellet_code }}" {% if form_data and form_data.pellet_code_select == pellet_code %}selected{% endif %}>{{ pellet_code }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Manual entry supports direct typing/pasting of the pellet code string. -->
      <label>Pellet Code code (manual)
        <input name="pellet_code_manual" placeholder="AB AB AC" value="{{ form_data.pellet_code_manual if form_data else '' }}" />
      </label>
      <!-- Conversion partner dropdown maps to a deterministic partner + machine pair. -->
      <label>Conversion partner
        <select name="conversion_partner_key" required>
          <option value="">Select partner</option>
          {% for option in partner_machine_options %}
          <option value="{{ option.key }}" {% if form_data and form_data.conversion_partner_key == option.key %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <!-- Native calendar input captures production date from which YYMMDD is derived. -->
      <label>Date of production
        <input type="date" name="production_date" required value="{{ form_data.production_date if form_data else '' }}" />
      </label>
      <!-- YYMMDD display auto-populates from selected date and remains user-visible for verification. -->
      <label>YYMMDD code
        <input readonly value="{{ form_data.production_date[2:4] ~ form_data.production_date[5:7] ~ form_data.production_date[8:10] if form_data and form_data.production_date else '' }}" placeholder="240827" />
      </label>
    </div>
    <!-- Full-width primary action creates the final Conversion ID. -->
    <button type="submit">Generate Conversion ID</button>
  </form>
  <!-- Success message confirms the generated conversion code in plain text. -->
  {% if result %}
  <p><strong>Generated conversion code:</strong> {{ result.how_code }}</p>
  {% endif %}
</section>

<!-- Conversion code list panel mirrors screenshot structure with filter controls and pagination row. -->
<section class="panel">
  <!-- Section heading matches required title exactly. -->
  <h2>Conversion codes</h2>
  <!-- Filter row narrows conversion-code results by free-text query input. -->
  <form method="get" class="inline-actions">
    <label>Filter conversion code <input name="q" value="{{ filters.q }}" placeholder="e.g. AB AC, 250112" /></label>
    <button type="submit">Filter</button>
  </form>
  <!-- Conversion code table keeps required columns only for Context page. -->
  <table>
    <thead>
      <tr>
        <th>CONVERSION CODE</th>
        <th>OWNER</th>
        <th>CONVERSION PARTNER</th>
        <th>DATE CREATED</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.conversion_code }}</td>
        <td>{{ row.owner }}</td>
        <td>{{ row.conversion_partner }}</td>
        <td>{{ row.created_at }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">No conversion codes loaded.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Pagination controls provide Previous / Page X of Y / Next layout. -->
  <div class="inline-actions">
    {% if pagination.has_prev %}
    <a href="/conversion1/context?page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}&q={{ filters.q | urlencode }}">Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }} of {{ ((pagination.total + pagination.page_size - 1) // pagination.page_size) if pagination.total else 1 }}</span>
    {% if pagination.has_next %}
    <a href="/conversion1/context?page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}&q={{ filters.q | urlencode }}">Next</a>
    {% endif %}
  </div>
</section>
{% endblock %}
